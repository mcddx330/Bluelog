# Bluelog ユーザー機能設計

## 1. 概要

このドキュメントは、Bluelogにおけるユーザー機能、特にユーザー情報の保存とプライバシー設定に関する設計を定義する。

## 2. ユーザーストーリー

- ユーザーとして、Blueskyアカウントでログインできる。
- ユーザーとして、ログイン時にBlueskyのプロフィール情報（表示名、アイコン、フォロワー数など）がBluelogに保存される。
- ユーザーとして、Bluelog上の自分のプロフィールページ（投稿一覧やいいね一覧）を、他のユーザーに対して非公開に設定できる。

## 3. データモデル

ユーザー情報を格納するために `users` テーブルを使用する。

### `users` テーブル定義

| カラム名 | 型 | 説明 |
|---|---|---|
| `did` | `string` (PK) | Blueskyの分散型識別子 (Decentralized Identifier)。主キー。 |
| `handle` | `string` | ユーザーハンドル (@example.bsky.social) |
| `display_name` | `string` | 表示名 |
| `description` | `text` | プロフィール説明文 |
| `avatar_url` | `string` | アバター画像のURL |
| `banner_url` | `string` | バナー画像のURL |
| `followers_count` | `integer` | フォロワー数 |
| `following_count` | `integer` | フォロー数 |
| `registered_at` | `datetime` | Blueskyへのアカウント登録日時 (`app.bsky.actor.getProfile` の `createdAt` を格納) |
| `last_login_at` | `datetime` | Bluelogへの最終ログイン日時 |
| `last_fetched_at` | `datetime` | バッチ処理などで最後に投稿やいいねを取得した日時 |
| `access_jwt` | `text` | Bluesky APIへのアクセストークン |
| `refresh_jwt` | `text` | Bluesky APIへのリフレッシュトークン |
| `last_synced_post_cid` | `string` | 最後に同期した投稿のCID |
| `last_synced_like_cid` | `string` | 最後に同期した「いいね」のCID |
| `is_private` | `boolean` | プロフィールの公開・非公開フラグ (デフォルト: `false`) |
| `is_fetching` | `boolean` | データ取得中フラグ (デフォルト: `false`) |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |
| `is_early_adopter` | `boolean` | 招待コードを使用して登録した早期採用者であるかを示すフラグ (デフォルト: `false`) |
| `invisible_badge` | `boolean` | アカウントステータスバッジの非表示フラグ (デフォルト: `false`) |

### `invitation_codes` テーブル定義 (新規)
招待コードの管理と複数回利用を可能にするためのテーブル。

| カラム名 | 型 | 説明 |
|---|---|---|
| `id` | `uuid` (PK) | 招待コードレコードのUUID。 |
| `code` | `string` | 招待コード文字列。ユニーク。 |
| `issued_by_user_did` | `uuid` (FK) | この招待コードを発行したユーザーのDID (`users` テーブルの外部キー)。管理者が発行した場合は `NULL`。 |
| `usage_limit` | `integer` | この招待コードが使用できる最大回数。`NULL` の場合は無制限。 |
| `current_usage_count` | `integer` | この招待コードが現在までに使用された回数 (デフォルト: `0`)。 |
| `expires_at` | `datetime` | この招待コードの有効期限。`NULL` の場合は無期限。 |
| `status` | `enum` | 招待コードの状態 (`active`, `inactive`)。`active` は現在有効なコード、`inactive` は再生成などにより無効化されたコード。デフォルト `active`。 |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

### `invitation_code_usages` テーブル定義 (新規)
招待コードの使用履歴を記録するためのテーブル。

| カラム名                 | 型 | 説明 |
|----------------------|---|---|
| `id`                 | `uuid` (PK) | 使用履歴レコードのUUID。 |
| `invitation_code_id` | `uuid` (FK) | 使用された招待コードのID (`invitation_codes` テーブルの外部キー)。 |
| `used_by_user_did`   | `uuid` (FK) | この招待コードを使用したユーザーのDID (`users` テーブルの外部キー)。 |
| `created_at`         | `timestamp` | レコード作成日時 (招待コードが使用された日時)。 |
| `updated_at`         | `timestamp` | レコード更新日時。 |

### `patrons` テーブル定義 (新規)
パトロンとして登録されたBlueskyユーザーのハンドルとDIDを管理するためのテーブル。

| カラム名 | 型 | 説明 |
|---|---|---|
| `id` | `uuid` (PK) | パトロンレコードのUUID。 |
| `handle` | `string` | パトロンのBlueskyハンドル (@username)。CSVから読み込む情報。ユニーク。 |
| `did` | `string` | パトロンのBluesky DID。`users`テーブルの`did`への外部キー。ユニーク。 |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

### `posts` テーブル定義

| カラム名 | 型 | 説明 |
|---|---|---|
| `id` | `uuid` (PK) | ポストレコードのUUID。 |
| `did` | `string` | 投稿者のDID (usersテーブルの外部キー)。 |
| `uri` | `string` | ポストのURI (`at://` 形式)。 |
| `cid` | `string` | コンテンツID。 |
| `rkey` | `string` | レコードキー。 |
| `text` | `longText` | ポスト本文。 |
| `reply_to` | `string` | リプライ先URI。 |
| `reply_to_handle` | `string` | リプライ先のハンドル。 |
| `quote_of` | `string` | 引用元URI。 |
| `is_repost` | `boolean` | リポストかどうか。 |
| `likes_count` | `unsignedBigInteger` | いいね数。 |
| `replies_count` | `unsignedBigInteger` | リプライ数。 |
| `reposts_count` | `unsignedBigInteger` | リポスト数。 |
| `posted_at` | `datetime` | 投稿日時。 |
| `indexed_at` | `datetime` | インデックス日時。 |
| `posted_date_only` | `date` | 投稿日 (日付のみ)。 |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

### `media` テーブル定義

| カラム名 | 型 | 説明 |
|---|---|---|
| `id` | `uuid` (PK) | メディアレコードのUUID。 |
| `post_cid` | `string` | 対象のポストCID (postsテーブルの外部キー)。 |
| `type` | `string` | メディアタイプ (image, video等)。 |
| `alt_text` | `text` | 代替テキスト。 |
| `size` | `string` | ファイルサイズ。 |
| `mime` | `string` | MIME Type。 |
| `fullsize_url` | `string` | フルサイズ画像URL。 |
| `thumbnail_url` | `string` | サムネイルURL。 |
| `aspect_ratio_width` | `unsignedInteger` | アスペクト比（幅）。 |
| `aspect_ratio_height` | `unsignedInteger` | アスペクト比（高さ）。 |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

### `likes` テーブル定義

| カラム名 | 型 | 説明 |
|---|---|---|
| `did` | `string` (PK) | Blueskyの分散型識別子 (Decentralized Identifier)。主キー。 |
| `handle` | `string` | ユーザーハンドル (@example.bsky.social) |
| `display_name` | `string` | 表示名 |
| `description` | `text` | プロフィール説明文 |
| `avatar_url` | `string` | アバター画像のURL |
| `banner_url` | `string` | バナー画像のURL |
| `followers_count` | `integer` | フォロワー数 |
| `following_count` | `integer` | フォロー数 |
| `posts_count` | `unsignedBigInteger` | 総ポスト数 |
| `registered_at` | `datetime` | Blueskyへのアカウント登録日時 (`app.bsky.actor.getProfile` の `createdAt` を格納) |
| `last_login_at` | `datetime` | Bluelogへの最終ログイン日時 |
| `last_fetched_at` | `datetime` | バッチ処理などで最後に投稿やいいねを取得した日時 |
| `access_jwt` | `text` | Bluesky APIへのアクセストークン |
| `refresh_jwt` | `text` | Bluesky APIへのリフレッシュトークン |
| `post_fetch_cursor` | `string` | 投稿の差分取得に使用するカーソル |
| `like_fetch_cursor` | `string` | いいねの差分取得に使用するカーソル |
| `is_private` | `boolean` | プロフィールの公開・非公開フラグ (デフォルト: `false`) |
| `is_fetching` | `boolean` | データ取得中フラグ (デフォルト: `false`) |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

### `likes` テーブル定義

| カラム名 | 型 | 説明 |
|---|---|---|
| `id` | `uuid` (PK) | いいねレコードのUUID。 |
| `did` | `string` | いいねを行ったユーザーのDID (usersテーブルの外部キー)。 |
| `post_uri` | `string` | いいねしたポストのURI (`at://` 形式)。 |
| `cid` | `string` | いいねしたポストのCID。 |
| `post_posted_at` | `timestamp` | いいねしたポストの投稿日時。 |
| `created_by_did` | `string` | いいねしたポストの作成者のDID。 |
| `post_posted_at` | `timestamp` | いいねしたポストの投稿日時。 |
| `created_at` | `timestamp` | レコード作成日時 (いいねした日時)。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

### `hashtags` テーブル定義

| カラム名 | 型 | 説明 |
|---|---|---|
| `id` | `uuid` (PK) | 各ハッシュタグレコードの一意な識別子。 |
| `post_id` | `uuid` | 関連する`posts`テーブルの`id`（UUID）を参照。 |
| `tag` | `string` | ハッシュタグのテキスト。 |
| `created_at` | `timestamp` | レコード作成日時。 |
| `updated_at` | `timestamp` | レコード更新日時。 |

## 4. 機能仕様

### 4.x. 招待コードの管理と利用 (新規)
Bluelogでは、サービス稼働初期のユーザー登録を招待コード制とします。招待コードは複数回利用可能であり、その利用状況を詳細に追跡します。

**4.x.1. 招待コードの生成**
*   管理者または特定の権限を持つユーザーは、新しい招待コードを生成できる。
*   生成時には、コード文字列、発行者、使用回数制限、有効期限を設定できる。
*   **1人のユーザーが同時にアクティブな招待コードを複数持つことはできない。新しいコードを生成した場合、以前のアクティブなコードは `inactive` 状態に更新される。**

**4.x.2. 招待コードの利用**
*   ユーザー登録時、招待コードの入力を必須とする。
*   入力された招待コードは以下の条件で検証される。
    *   コードが存在し、`status` が `active` であること。
    *   有効期限内であること (`expires_at` が `NULL` または現在日時より未来であること)。
    *   使用回数制限がある場合、`current_usage_count` が `usage_limit` 未満であること。
*   検証に成功した場合、`invitation_codes` テーブルの `current_usage_count` をインクリメントし、`invitation_code_usages` テーブルに利用履歴を記録する。
*   **招待コードを使用して登録したユーザーには、`users` テーブルの `is_early_adopter` フラグを `true` に設定する。**
*   **新規登録時のみコードを取り扱い、既にアカウント登録済みのユーザーがコードを入力した場合は、コード処理を全て無視する。**

**4.x.3. 早期採用者特典**
*   `is_early_adopter` フラグが `true` のユーザーは、プロフィールページなどで「早期採用者」を示すバッジが表示される。バッジの文言やデザインはビュー側で制御される。

**4.x.4. 招待コードの使用状況の表示**
*   招待コードを生成したユーザーは、自身の設定画面で、発行した招待コードの現在の状態（`active`, `used`, `inactive`）、使用回数、有効期限、そしてそのコードを使用したユーザーのリスト（`invitation_code_usages` テーブルから取得）を確認できる。

### 4.0. Blueskyの「Logged-out visibility」設定とBluelogのプライバシー管理について

### 4.0. Blueskyの「Logged-out visibility」設定とBluelogのプライバシー管理について

Bluelogでは、ユーザーのプライバシーを尊重し、Bluesky側の設定とBluelogサービス内での表示制御の連携について検討しました。

**Blueskyの「Logged-out visibility」設定について**

Blueskyには「Logged-out visibility」（ログアウトしたユーザーからの可視性）という設定が存在します。この設定を有効にすると、Blueskyはログアウトしているユーザーに対してコンテンツを表示しないよう推奨しますが、これはアカウントを完全に非公開にするものではありません。Blueskyはオープンなプラットフォームであり、第三者のアプリケーションがこの設定を尊重しない場合や、直接リンクを知っている場合は、コンテンツが表示される可能性があります。

**Bluesky APIによる設定取得の現状**

現在のBluesky APIでは、ユーザーの「Logged-out visibility」設定を直接取得できるエンドポイントは確認されていません。そのため、BluelogがBluesky側のこの設定を自動的に検知し、サービス内の表示に連動させることは技術的に困難です。

**Bluelogにおけるプライバシー管理の原則**

上記の状況を踏まえ、Bluelogでは以下の原則に基づきユーザーのプライバシー管理を行います。

1.  **`is_private` フラグの役割:** Bluelogの `users` テーブルに存在する `is_private` フラグは、Bluelogサービス内での表示制御に限定されます。このフラグが `true` の場合、Bluelog上では本人以外のユーザーに対してプロフィールや投稿、いいねなどのコンテンツは表示されません。
2.  **ユーザーによる管理:** `is_private` フラグのON/OFFは、ユーザー自身がBluelogの設定画面を通じて自由に管理できます。
3.  **Bluesky側の設定との独立性:** Bluesky APIで「Logged-out visibility」設定を取得できないため、Bluelogの `is_private` フラグはBluesky側の同設定とは自動的に連動しません。ユーザーは、BluelogとBlueskyそれぞれのプラットフォームで、自身のプライバシー設定を個別に管理する必要があります。

この方針により、Bluelogはユーザーが自身のデータをどのように表示したいかという意向を尊重しつつ、現在の技術的な制約の中で最適なプライバシー制御を提供します。

## 5. データベース設計における外部キー制約の重要性

本プロジェクトでは、データの整合性と正確性を保つため、リレーショナルデータベースの外部キー制約を積極的に利用しています。特に、`posts` テーブルと `media` テーブル、`likes` テーブル、`daily_stats` テーブルのように、関連性を持つデータ間での整合性を保証するために不可欠です。

### 外部キー制約の役割

外部キー制約の主な役割は、以下の「参照整合性」を保証することにあります。

1.  **無効な参照の防止**: 子テーブル（例: `media`, `likes`, `daily_stats`）のレコードが、存在しない親テーブル（例: `posts`, `users`）のレコードを参照することを防ぎます。これにより、「紐づくはずの親データが存在しない」という矛盾した状態が発生するのを防ぎます。
2.  **関係性の明確化**: テーブル間の論理的な関係性（例: 1つの投稿に複数のメディアが紐づく、1人のユーザーに複数のいいねや日別統計が紐づく）をデータベースレベルで強制し、データモデルの一貫性を保ちます。

### 参照されるカラムの一意性

外部キー制約が正しく機能するためには、参照される側のカラム（親テーブルのキー、例: `posts` テーブルの `cid` や `users` テーブルの `did`）が、そのテーブル内で**一意（ユニーク）**である必要があります。これは、`PRIMARY KEY`（主キー）であるか、または `UNIQUE` 制約が明示的に付与されていることで保証されます。

もし参照されるカラムが一意でない場合、データベースは子レコードがどの親レコードを参照すべきかを特定できず、データの整合性を保証できません。このため、外部キー制約違反のエラーが発生します。

### `ON DELETE CASCADE` との関連

`ON DELETE CASCADE` は、親レコードが削除された際に、それに紐づく子レコードも自動的に削除するという便利な機能です。しかし、これは外部キー制約が提供する機能の一部であり、外部キー制約の**本質的な目的は、あくまで上述の参照整合性の保証**にあります。`ON DELETE CASCADE` は、参照整合性を保ちつつ、関連データの削除を自動化するためのオプション機能として理解すべきです。

この原則を理解し適用することで、アプリケーションのデータ層における堅牢性と信頼性を高めることができます。

### 4.1. ログイン (`doLogin`)

1.  ユーザーがIdentifierとパスワードを入力してログインする。
2.  `com.atproto.server.createSession` を使用してBlueskyのセッションを作成し、`accessJwt` と `refreshJwt` を取得する。
3.  取得したセッション情報を使用して `app.bsky.actor.getProfile` を呼び出し、最新のプロフィール情報を取得する。

### 4.1.1. プロフィール情報の取得とバナー画像URL

Blueskyアカウントのバナー画像URLは、`app.bsky.actor.getProfile` または `app.bsky.actor.getProfiles` エンドポイントを通じて取得できます。これらのエンドポイントから返されるプロフィール情報には `banner` フィールドが含まれており、これがバナー画像のURLとなります。

`revolution/laravel-bluesky` パッケージを使用している場合、内部で利用されている `potibm/phluesky` クライアントを介してこの情報を取得し、`users` テーブルの `banner_url` カラムに保存します。
4.  取得した情報（`did`, `handle`, `displayName`, `createdAt` など）とBluesky API認証トークンを `users` テーブルに `updateOrCreate` で保存・更新する。
    - `did` をキーとして、既存ユーザーか新規ユーザーかを判断する。
    - `last_login_at` を現在日時に更新する。
    - **`refresh_jwt` は `users` テーブルの `refresh_jwt` カラムに暗号化して保存する。**
    - **`access_jwt` は、ユーザーのWebセッション中にサーバーサイドのセッションに保存する。**
    - `refresh_jwt` と `access_jwt` は、サービス上ではCryptにて暗号化・復号化をして使用する。生のキーを記録しない。そのため、 `.env` の `APP_KEY` の取り扱いに気をつけること。
5.  Laravelの `Auth` ファサードを使用して、アプリケーションのセッションを開始する。

### 4.2. プロフィール表示 (`showProfile`, `showLikes`)

1.  リクエストされた `{handle}` に紐づくユーザーを `users` テーブルから検索する。
2.  対象ユーザーの `is_private` フラグの値を確認する。
3.  **もし `is_private` が `true` の場合:**
    - 現在ログインしている認証済みユーザーの `did` と、表示対象プロフィールの `did` を比較する。
    - 2つが一致しない（本人でない）場合、投稿やいいねの一覧は表示せず、「このプロフィールは非公開です」というメッセージを表示する。
4.  **もし `is_private` が `false` の場合、または本人がアクセスしている場合:**
    - 通常通り、プロフィール情報、投稿一覧、いいね一覧を表示する。
    - **いいね一覧の表示 (`showLikes`):**
        - `likes` テーブルからいいねレコードを取得する。
        - 取得したいいねレコードは、**いいねした日時 (`created_at`) の降順でソートする。**
        - 各いいねレコードの `post_uri` (at://形式) と `cid` を使用し、Bluesky公式の埋め込みスニペット (`<blockquote class="bluesky-embed" data-bluesky-uri="..." data-bluesky-cid="...">`) を生成して表示する。
        - 埋め込みスニペットのレンダリングには、`https://embed.bsky.app/static/embed.js` を使用する。
        - `created_by_did` は、ポスト作成者のDIDを効率的に検索するために保持する。

### 4.2.1. ユーザー関連ページへのアクセス時の共通リダイレクト挙動

Bluelogにおけるユーザー関連の各ページ（例: プロフィール、アーカイブ、いいね、リプライ、ハッシュタグ、統計など）へのアクセス時、対象のユーザーが存在しない場合、またはそのユーザーがプロフィールを非公開設定にしている場合（かつ閲覧者が本人ではない場合）、一律でユーザートップページへリダイレクトされます。

このリダイレクトは、ユーザーが存在しない、または非公開であるという情報をユーザートップページで一元的に表示するための設計です。これにより、ユーザーはどのユーザー関連ページからアクセスしても、対象のハンドルに関する状況を一貫したメッセージで把握することができます。

### 4.3. 設定画面 (settings.edit)

- ログインユーザー向けに設定ページ (`/settings`) を作成する。
- 設定ページには「**Bluelogのプロフィールを非公開にする**」というチェックボックスを設ける。
- ユーザーがこの設定を変更すると、対応する `users` レコードの `is_private` フラグが更新される。

### 4.4. いいね画面 (profile.likes)

- **概要:** ユーザーがいいねしたBlueskyのポストを一覧表示する。
- **表示方法:** Bluesky公式の埋め込み機能を利用し、各ポストを `<iframe>` ではなく、`<blockquote>` タグとJavaScript (`https://embed.bsky.app/static/embed.js`) を用いて埋め込む。
- **データソース:** `likes` テーブルから取得した `post_uri` (at://形式) と `cid` を `data-bluesky-uri` および `data-bluesky-cid` 属性として `<blockquote>` タグに設定する。**取得したデータは、いいねした日時 (`created_at`) の降順でソートする。**
- **表示項目:**
    - いいねした日時 (`liked_at`)
    - 埋め込まれたBlueskyポスト
- **プライバシー:** 4.2. プロフィール表示 (`showProfile`, `showLikes`) のプライバシー設定に従い、非公開設定の場合は本人以外には表示しない。

### 4.5. リプライランキング表示におけるデータ取り扱い

この機能は、Blueskyの投稿データからリプライされたユーザーのハンドルを集計し、そのリプライ回数に基づいたランキングを生成・表示します。

#### 4.5.1. データソースと集計ロジック

-   **データソース**: `posts` テーブルの `reply_to_handle` カラムを使用します。
-   **集計対象**: `reply_to_handle` カラムが `NULL` でない投稿のみを集計対象とします。
-   **集計方法**:
    1.  `posts` テーブルから `reply_to_handle` の値を抽出します。
    2.  抽出したハンドル名ごとにグループ化し、各ハンドルの出現回数（リプライ回数）をカウントします。
    3.  結果は、リプライ回数の降順（多い順）でソートします。
    4.  リプライ回数が同じハンドルが複数ある場合、それらのハンドルはアルファベット順（昇順）でソートし、順位を確定させます。

---

### 4.6. ハッシュタグランキング表示におけるデータ取り扱い

この機能は、Blueskyの投稿データに含まれるハッシュタグ情報を利用して、その出現頻度に基づいたランキングを表示します。Bluesky APIのレスポンスに含まれる`facets`データからハッシュタグを抽出し、これを専用のテーブルに保存することで、正確かつ効率的な集計を実現します。

#### 4.6.1. データモデルの定義と集計ロジック

*   **`hashtags` テーブルの新規作成**:
    *   `id` (UUID, プライマリキー): 各ハッシュタグレコードの一意な識別子。`likes`や`media`テーブルと同様に、モデルの`boot`メソッドで自動生成します。
    *   `post_id` (UUID, 外部キー): 関連する`posts`テーブルの`id`（UUID）を参照します。これにより、どの投稿にどのハッシュタグが含まれるかを正確に紐付けます。
    *   `tag` (文字列): ハッシュタグのテキスト（例: "Bluesky", "Laravel"）。
    *   `created_at`, `updated_at` (タイムスタンプ): レコードの作成日時と更新日時。
    *   **ユニーク制約**: `post_id`と`tag`の組み合わせにユニーク制約を設定し、同じ投稿に同じハッシュタグが重複して保存されないようにします。

*   **`Hashtag` モデルからの集計**:
    *   `Hashtag` モデルに対して、`tag` カラムでグループ化を行い、各ハッシュタグの出現回数をカウントします。
    *   結果は、カウント数の降順で並べ替えます。
    *   カウント数が同じハッシュタグについては、ハッシュタグのアルファベット順（昇順）で並べ替えます。

### 4.7. 投稿検索機能

この機能は、ユーザーのプロフィールページに検索インターフェースを提供し、表示されている投稿の中からキーワードによる部分一致検索を可能にします。

#### 4.7.1. 検索インターフェース

*   **配置場所**: プロフィールビュー (`resources/views/profile.blade.php`) 内の投稿ヒートマップの下に検索フォームを配置します。
*   **UI要素**:
    *   **テキスト入力フィールド**: ユーザーが検索キーワードを入力するための `<input type="text" name="search_text">`。
    *   **検索ボタン**: 検索を実行するための `<button type="submit">`。
    *   **クリアボタン**: 検索キーワードをクリアし、全ての投稿を表示するためのリンクまたはボタン。
*   **動作**: 検索フォームはGETメソッドでプロフィール表示ルート (`profile.show`) にリクエストを送信し、`search_text`というクエリパラメータにキーワードを含めます。

#### 4.7.2. バックエンド処理

*   **ルーティング**: `routes/web.php`で定義されている`profile.show`ルートは、`search_text`クエリパラメータを受け入れます。
*   **コントローラー (`app/Http/Controllers/BlueskyController.php`)**:
    *   `showProfile`メソッド内で、リクエストから`search_text`クエリパラメータを取得します。
    *   `search_text`が存在する場合、`Post`モデルのクエリに以下の条件を追加します。
        *   対象ユーザーの投稿 (`did`によるフィルタリング) に限定します。
        *   `text`カラムに対して、SQLの`LIKE`演算子とワイルドカード (`%`) を用いた部分一致検索 (`->where('text', 'LIKE', '%' . $searchText . '%')`) を適用します。
    *   フィルタリングされた投稿データがビューに渡され、表示されます。
*   **データベースクエリ**: LaravelのEloquent ORMを使用して、`posts`テーブルの`text`カラムに対して部分一致検索を実行します。現在の開発環境ではSQLiteを使用しており、`LIKE`演算子が利用されます。

#### 4.7.3. パフォーマンスに関する考慮事項

*   **現状**: SQLiteにおける`LIKE '%キーワード%'`の部分一致検索は、インデックスが利用できないため、データ量が増加するとパフォーマンスが低下する可能性があります。
*   **将来的な対応**: 本番環境への移行時には、MariaDBとMroongaのような全文検索エンジンを導入することで、大規模なデータセットに対しても高速な全文検索を実現する計画です。これにより、開発速度を維持しつつ、将来的なパフォーマンス要件を満たします。

### 4.8. ポスト一覧の並び替え機能

#### 概要
ユーザーが自身のプロフィールページで表示されるポスト一覧の並び順を、以下の3つのオプションで変更できる機能を追加します。

*   **全て降順:** 最新のポストから古いポストへ（デフォルト）
*   **全て昇順:** 最も古いポストから最新のポストへ
*   **1日単位で朝から夜（昇順）:** 日付ごとにグループ化し、各日付内では古いポストから新しいポストへ

#### 実装詳細

1.  **UI (フロントエンド)**
    *   **ファイル:** `resources/views/profile.blade.php`
    *   **要素:** 投稿検索フォームの下、または「Posts」セクションの直前に、並び替えオプションを表す3つのボタン（`<a>` タグ）を配置します。
    *   **リンク:** 各ボタンは、現在のURLに `sort` クエリパラメータを追加または更新するリンクとなります。既存の検索テキスト (`search_text`) やアーカイブ (`archive_ym`) など、他のクエリパラメータは保持されます。
        *   例: `route('profile.show', array_merge(request()->query(), ['handle' => $handle, 'sort' => 'posted_at_desc']))`
    *   **アクティブ状態:** 現在選択されている並び替えオプションに対応するボタンは、Tailwind CSSのクラス（例: `bg-blue-500 text-white`）を適用することで、視覚的にアクティブ状態であることを示します。`sort` パラメータが指定されていない場合は、「全て降順」がデフォルトでアクティブとなります。

2.  **バックエンド (コントローラー)**
    *   **ファイル:** `app/Http/Controllers/BlueskyController.php`
    *   **メソッド:** `showProfile` メソッドを修正します。
    *   **パラメータ取得:** `Illuminate\Http\Request` オブジェクトから `sort` クエリパラメータの値を取得します。デフォルト値は `'posted_at_desc'` とします。
    *   **クエリ変更:** 投稿を取得するデータベースクエリに、取得した `sort` の値に基づいて `orderBy` 句を追加します。

3.  **データベースクエリ (モデル/クエリビルダ)**
    *   **ファイル:** `app/Models/Post.php` または `BlueskyController.php` 内のクエリビルダ
    *   **並び替えロジック:**
        *   **「全て降順」 (`sort = 'posted_at_desc'`):**
            ```php
            ->orderBy('posted_at', 'desc')
            ```
        *   **「全て昇順」 (`sort = 'posted_at_asc'`):**
            ```php
            ->orderBy('posted_at', 'asc')
            ```
        *   **「1日単位で朝から夜（昇順）」 (`sort = 'posted_date_only_asc'`):**
            *   まず日付部分で昇順にソートし、次に同じ日付内の `posted_at` を昇順にソートします。
            ```php
            ->orderBy('posted_date_only', 'asc') // 生成列で日付部分を昇順
            ->orderBy('posted_at', 'asc')       // 同じ日付内を時間で昇順
            ```

#### 考慮事項とパフォーマンス

*   **既存フィルタリングとの連携:** 投稿検索やアーカイブフィルタリングが適用されている場合でも、並び替えオプションの変更によってそれらのフィルタリングが解除されないよう、URL生成時に既存のクエリパラメータをすべて引き継ぐように設計します。

*   **パフォーマンスとインデックス:**
    *   `posts` テーブルの `posted_at` カラムにインデックスが設定されていない場合、全ての並び替え操作がフルテーブルスキャンを引き起こし、データ量が増加するとパフォーマンスが低下する可能性があります。
    *   **解決策:** `posted_at` カラムにデータベースインデックスを追加することで、「全て降順」および「全て昇順」の並び替えにおけるクエリパフォーマンスは大幅に向上します。インデックスにより、データベースは効率的にデータを検索・ソートできるようになります。
    *   **「1日単位で朝から夜（昇順）」の最適化:**
        *   `posted_at` カラムに対して `DATE()` 関数を適用してソートする場合（例: `orderByRaw('DATE(posted_at) ASC')`）、`posted_at` にインデックスがあってもそのインデックスは直接利用されません。これは、インデックスがカラムの生の値に基づいて構築されるため、関数によって計算された新しい値には適用されないためです。
        *   このパフォーマンス問題を解決するため、`posts` テーブルに `posted_at` の日付部分のみを格納する専用の `DATE` 型カラム（例: `posted_date_only`）を**生成列（Generated Column）**として追加し、これにインデックスを貼ることで、日付部分での高速なソートを可能にします。
        *   この生成列は、データベースが `posted_at` から日付部分を自動的に抽出し、格納します。アプリケーション側で値を管理する必要はありません。
        *   `posted_date_only` カラムにインデックスを貼ることで、日付部分での高速なソートが可能となり、`posted_date_only` と `posted_at` を組み合わせたソート（例: `orderBy('posted_date_only', 'asc')->orderBy('posted_at', 'asc')`）が効率的に実行されます。
        *   このアプローチは、開発環境のSQLiteおよび本番環境のMariaDB（MySQL互換）の両方でサポートされており、データベースの機能を最大限に活用することで、アプリケーション側の複雑性を排除し、堅牢かつスケーラブルなソートを実現します。

### 4.9. アカウント削除

ユーザーがBluelogアカウントを削除する際の挙動について定義します。

#### 概要

Bluelogのアカウント削除は、ユーザーのBluesky DIDに紐づく全てのBluelog内データを削除し、セッションを無効化する操作です。

#### 削除されるデータ

`users` テーブルのレコードが削除されると、データベースの外部キー制約 `onDelete('cascade')` の設定により、以下の関連テーブルのレコードも自動的に削除されます。

*   `posts` テーブル (ユーザーの投稿データ)
*   `likes` テーブル (ユーザーのいいねデータ)

*   `daily_stats` テーブル (ユーザーの日別統計データ)
*   `hashtags` テーブル (投稿に紐づくハッシュタグデータ)


これにより、アプリケーション側で個々の関連データを明示的に削除するロジックを記述する必要がなく、データの整合性を保ちつつ効率的な削除が可能です。

#### 処理フロー

1.  **ユーザー認証**: アカウント削除リクエストは、認証済みのユーザーからのみ受け付けます。
2.  **ユーザーレコードの削除**: 認証済みユーザーの `users` テーブルのレコードを削除します。この操作により、上述の関連データが自動的に削除されます。
3.  **認証セッションのクリア**: ユーザーの `Bluelog` アプリケーションにおける認証セッションを無効化し、ログアウト状態にします。これは、ログイン時に発行された `access_jwt` や `refresh_jwt` などのセッション情報をクリアすることを意味します。
4.  **関連ファイルの削除 (将来的な考慮)**: 現在のBluelogでは、プロフィール画像や投稿のメディアはBlueskyのURLを参照しており、Bluelog内部でファイルを管理していません。しかし、将来的にユーザーがBluelogに直接ファイルをアップロードする機能が追加された場合（例: カスタムプロフィール画像、プライベートなメモなど）、それらのローカルファイルもアカウント削除時に適切に削除するロジックを追加する必要があります。

#### 実装予定

*   `app/Http/Controllers/SettingsController.php` にアカウント削除用の `destroy` メソッドを追加します。
*   `routes/web.php` にアカウント削除用のルート (`DELETE /settings`) を追加します。
*   `resources/views/settings/edit.blade.php` にアカウント削除ボタンと、誤操作を防ぐための確認ダイアログを追加します。

この設計により、Bluelogはユーザーが自身のデータを完全に管理し、必要に応じてアカウントを安全に削除できる機能を提供します。

### 4.10. 投稿削除

ユーザーがBluelog上で自身の投稿を削除する際の挙動について定義します。

#### 概要

Bluelogの投稿削除機能は、認証済みユーザーが自身のBluesky DIDに紐づく特定の投稿をBluelog内から削除する操作です。

#### 削除されるデータ

`posts` テーブルのレコードが削除されると、データベースの外部キー制約 `onDelete('cascade')` の設定により、以下の関連テーブルのレコードも自動的に削除されます。

*   `media` テーブル (投稿に紐づくメディアデータ)
*   `hashtags` テーブル (投稿に紐づくハッシュタグデータ)

これにより、アプリケーション側で個々の関連データを明示的に削除するロジックを記述する必要がなく、データの整合性を保ちつつ効率的な削除が可能です。

#### 処理フロー

1.  **ユーザー認証**: 投稿削除リクエストは、認証済みのユーザーからのみ受け付けます。
2.  **投稿所有権の確認**: 削除対象の投稿が、リクエストを行ったユーザーのものであることを確認します。具体的には、削除対象のポストの `did` が現在認証されているユーザーの `did` と一致する場合にのみ削除を許可します。
3.  **投稿レコードの削除**: 認証済みユーザーが所有する `posts` テーブルのレコードを削除します。この操作により、上述の関連データが自動的に削除されます。

#### 実装済み

*   `app/Http/Controllers/BlueskyController.php` に投稿削除用の `deletePost` メソッドを実装済みです。
*   `routes/web.php` に投稿削除用のルート (`DELETE /posts/{post_id}`) を追加済みです。
*   `resources/views/components/profile-posts-section.blade.php` に投稿削除ボタンと、誤操作を防ぐための確認ダイアログを追加済みです。

### 4.11. プロフィール表示におけるリアルタイムカウント

ユーザープロフィール画面のヘッダーに表示される投稿数および「いいね」数は、`users`テーブルに保存されている集計値ではなく、関連する`posts`テーブルおよび`likes`テーブルからリアルタイムにカウントされた値を使用します。これにより、常に最新かつ正確な情報がユーザーに提供されます。

#### 4.11.1. 実装詳細

*   **データソース**: `App\Models\User`モデルのリレーション（`posts()`および`likes()`）を通じて、関連する`posts`テーブルおよび`likes`テーブルのレコード数を直接カウントします。
*   **データ準備**: `App\Traits\PreparesProfileData`トレイト内の`prepareCommonProfileData`メソッドにおいて、`$profile_data`配列の`posts_count`および`likes_count`属性に、このリアルタイムカウント値を設定します。
*   **ビュー層**: ビュー（`resources/views/components/profile-main-content.blade.php`）は、`$profile`オブジェクトからこれらの属性を参照することで、リアルタイムカウントを表示します。

### 4.12. ユーザーのステータス判定

Bluelogでは、ユーザーの特性をより詳細に把握し、それに応じた機能や表示を提供するため、以下の2つの主要なフラグとリレーションを用いてユーザーのステータスを判定します。

1.  **早期採用者 (`is_early_adopter` フラグ)**:
    *   **定義**: `users` テーブルの `is_early_adopter` カラム (`boolean`) で管理されます。招待コードを使用してBluelogに登録したユーザーに `true` が設定されます。
    *   **目的**: サービス初期からの貢献者を識別し、特別なバッジ表示などの特典を提供します。

2.  **パトロン (`patrons` テーブルとのリレーション)**:
    *   **定義**: 新しく導入される `patrons` テーブルにユーザーのDIDが存在するかどうかで判定されます。`users` モデルから `patrons` モデルへのリレーション（例: `hasOne`）を通じて確認されます。
    *   **目的**: サービスを支援するパトロンユーザーを識別し、パトロン限定機能や表示を提供します。

#### ステータス判定ロジック

これらの情報源を組み合わせることで、`User` モデルに以下のようなステータス判定ロジックを実装し、アプリケーション全体で一貫したユーザー特性の識別を可能にします。

| `is_early_adopter` | `patrons` テーブルに存在 | `invisible_badge` | 判定されるステータス | 結果 (バッジ表示) | 説明 |
|---|---|---|---|---|---|
| ✅ | ✅ | ❌ | `early_adopter_and_patron` | 表示あり ✅ | 早期採用者であり、かつパトロンであるユーザー。 |
| ✅ | ❌ | ❌ | `early_adopter` | 表示あり ✅ | 早期採用者であるが、パトロンではないユーザー。 |
| ❌ | ✅ | ❌ | `patron` | 表示あり ✅ | 早期採用者ではないが、パトロンであるユーザー。 |
| ❌ | ❌ | ❌ | `normal` | 表示なし ❌ | 早期採用者でもパトロンでもない通常のユーザー。 |
| ✅ | ✅ | ✅ | `early_adopter_and_patron` | 表示なし ❌ | 早期採用者であり、かつパトロンであるユーザー。 |
| ✅ | ❌ | ✅ | `early_adopter` | 表示なし ❌ | 早期採用者であるが、パトロンではないユーザー。 |
| ❌ | ✅ | ✅ | `patron` | 表示なし ❌ | 早期採用者ではないが、パトロンであるユーザー。 |
| ❌ | ❌ | ✅ | `normal` | 表示なし ❌ | 早期採用者でもパトロンでもない通常のユーザー。 |

この判定ロジックは、`User` モデルのアクセサ（例: `getAccountStatusAttribute()`）として実装することで、`$user->account_status` のように簡潔にユーザーのステータスを取得できるようになります。ビューでは、`$user->invisible_badge` の値に基づいてバッジの表示/非表示を制御します。これにより、ビューやコントローラーなど、アプリケーションの様々な場所でユーザーの特性に応じた処理を柔軟に記述できます。
