# Bluelog OSS開発ノート

このドキュメントは、Bluelogをオープンソースとしてセルフホスティング可能にするための開発に関する検討事項をまとめたものです。

### 1. 全体設定の導入

**目的:**
Bluelogがオープンソースとしてセルフホスティングされる際、各インスタンスの管理者が、アプリケーションの振る舞いを柔軟にカスタマイズできるようにすることが目的です。これには、新規ユーザー登録の許可/不許可、システム名、デフォルトのプライバシー設定など、様々な設定項目が含まれます。これらの設定をコード内にハードコードするのではなく、動的に変更可能な形で管理する基盤を構築します。

**アプローチ:**
*   **汎用的な設定テーブルの導入:** データベースに `settings` という汎用的なテーブルを導入します。このテーブルは、`key` (設定項目名) と `value` (設定値) のペアで構成され、アプリケーションのあらゆる設定を保存できる柔軟な構造とします。
*   **キャッシュ機構の活用:** 設定値はアプリケーションの様々な場所で頻繁に参照されるため、データベースへのアクセス負荷を軽減し、パフォーマンスを向上させるためにLaravelのキャッシュ機構を積極的に利用します。設定値が変更された際には、関連するキャッシュを適切にクリアする仕組みも導入します。
*   **管理者インターフェース:** 管理者がこれらの設定項目を容易に閲覧・変更できる専用の管理画面を提供します。この画面へのアクセスは、管理者権限を持つユーザーに限定し、セキュリティを確保します。

**メリット:**
*   **高い柔軟性:** アプリケーションの再デプロイなしに、運用中に設定を変更できるようになります。
*   **拡張性:** 将来的に新しい設定項目が必要になった場合でも、既存の仕組みを再利用して容易に追加できます。
*   **運用効率の向上:** 管理者が直感的なUIを通じてシステムを管理できるようになります。

### 2. 招待コード必須化のロジック

**目的:**
現在のBluelogの新規ユーザー登録は「自由登録（招待コードなしで登録可能）」であると想定し、これを管理者の設定によって「招待コード必須」の状態に切り替えられるようにすることが目的です。これにより、管理者はサービスの公開範囲を柔軟に調整し、例えば初期段階では招待コードを必須とすることでユーザー数を制限し、安定稼働後に自由登録に切り替えるといった運用が可能になります。

**アプローチ:**
*   **設定項目の追加:** 「全体設定」で導入する `settings` テーブルに、`registration_invitation_code_required` という新しい設定項目を追加します。この設定はブーリアン値（`true` または `false`）を持ち、初期値は `false`（自由登録）とします。
*   **登録フローへの組み込み:** ユーザー登録処理の初期段階で、この `registration_invitation_code_required` の設定値を参照します。
    *   設定が `false` の場合：現在の自由登録のフローを維持し、招待コードの入力は不要とします。
    *   設定が `true` の場合：招待コード入力フォームを表示し、招待コードのバリデーション（有効性、使用済みでないかなど）を厳格に適用します。
*   **既存ロジックの活用:** 招待コードの発行、検証、使用状況の追跡といった、Bluelogに既に実装されている招待コード関連のコアロジックは変更せず、その適用をこの新しい設定で制御します。

**メリット:**
*   **段階的な公開制御:** サービス提供者は、自由登録から招待コード必須、あるいはその逆へと、ユーザー登録の敷居を柔軟に調整できます。
*   **既存資産の有効活用:** 既存の堅牢な招待コードシステムを活かしつつ、その運用ポリシーを動的に変更できるようになります。

## 3. クローリング拒否設定

ユーザーのプライバシー保護とサーバー負荷軽減のために、以下の点を考慮する。

*   **`robots.txt`:** `public` ディレクトリに `robots.txt` を配置し、クローラーに指示を与える。
    *   例: `Disallow: /profile/*`, `Disallow: /settings/*` など、プライベートな情報を含むパスを明示的に拒否する。
*   **メタタグ (`<meta name="robots" content="noindex, nofollow">`):** 特に検索エンジンにインデックスされたくないページ（例: ログインページ、設定ページ、プライベートなプロフィールページ）のHTMLヘッダーにこのメタタグを追加する。
*   **HTTPヘッダー (`X-Robots-Tag`):** Laravelのミドルウェアで、特定のルートやコントローラーに対して `X-Robots-Tag: noindex, nofollow` ヘッダーを付与することも可能。これは `robots.txt` やメタタグよりも強力な指示となる。
*   **認証/認可:** ログインが必要なページは、そもそもクローラーがアクセスできないため、追加の対策は不要な場合が多いが、念のため上記の設定と併用するとより安全。

## 4. 環境構築とデプロイの容易さ

*   **Docker/Docker Compose:** `Dockerfile` と `docker-compose.yml` を提供し、ユーザーがコマンド一つで開発・本番環境を構築できるようにする。
*   **詳細なドキュメント:** `README.md` や専用の `INSTALL.md` などで、前提条件、インストール手順、初期設定、開発サーバーの起動方法などをステップバイステップで明確に記述する。
*   **設定ファイルの外部化:** `.env.example` を充実させ、ユーザーが変更する必要がある設定項目を分かりやすく提示する。

## 5. セキュリティ

*   **Laravelのベストプラクティス:** Laravelの組み込みセキュリティ機能（CSRF保護、XSS対策、SQLインジェクション対策など）を適切に利用していることを確認する。
*   **依存関係の管理:** `composer.json` と `package.json` で使用しているライブラリのバージョンを固定し、定期的なセキュリティアップデートを促す仕組みを検討する。
*   **シークレット管理:** `.env` ファイルの取り扱いについて注意喚起し、本番環境ではより安全な方法を推奨する。

## 6. 運用とメンテナンス

*   **バックアップとリストア:** データベースとアップロードされたファイル（もしあれば）のバックアップ方法、およびリストア手順をドキュメント化する。
*   **アップデートパス:** 新しいバージョンへのアップグレード手順を明確に示す。
*   **ログと監視:** Laravelのログ機能が適切に設定されており、エラー発生時に管理者が確認できることを保証する。

## 7. ライセンスと貢献

*   **OSSライセンス:** 適切なオープンソースライセンスを選択し、プロジェクトのルートに `LICENSE` ファイルとして含める。
*   **貢献ガイドライン:** `CONTRIBUTING.md` を作成し、バグ報告、機能提案、プルリクエストの作成方法など、コミュニティからの貢献を促すためのガイドラインを提供する。

## 8. 国際化 (i18n) / 地域化 (l10n)

*   **多言語対応:** 世界中のユーザーが利用することを想定し、UIのテキストやメッセージを多言語化できるようにする。Laravelの多言語機能（`lang` ディレクトリ、`__` ヘルパー関数など）を適切に利用する。
*   **日付・時刻のフォーマット:** ユーザーのロケールに応じた日付・時刻の表示に対応する。
*   **数値・通貨のフォーマット:** 同様に、ロケールに応じた数値や通貨の表示に対応する。

## 9. パフォーマンス最適化

*   **データベースクエリの最適化:** N+1問題の回避、適切なインデックスの利用、Eloquentの遅延ロード/Eagerロードの使い分けなど。
*   **キャッシュの活用:** 頻繁にアクセスされるデータ（設定値、ユーザー情報の一部など）をキャッシュする。Laravelのキャッシュドライバ（Redis, Memcachedなど）の利用を推奨する。
*   **フロントエンドの最適化:** Viteによるアセットのバンドル、ミニファイ、コード分割、画像最適化など。
*   **キューの利用:** 時間のかかる処理（Blueskyからのデータ同期、メール送信など）はキューに投入し、非同期で実行することでユーザー体験を向上させる。

## 10. テストカバレッジとCI/CD

*   **包括的なテスト:** ユニットテスト、フィーチャーテスト、ブラウザテストなど、様々なレベルでのテストを充実させる。
*   **CI/CDの導入推奨:** GitHub ActionsなどのCI/CDツールを利用し、コードの変更が自動的にテストされ、品質が保証される仕組みを推奨する。これにより、コミュニティからの貢献も受け入れやすくなる。

## 11. エラーハンドリングとデバッグ

*   **ユーザーフレンドリーなエラー表示:** ユーザーに分かりやすいエラーメッセージを提供し、デバッグ情報が本番環境で露出しないようにする。
*   **デバッグツールの活用:** Laravel Debugbarなどのデバッグツールを開発環境での利用を推奨し、問題発生時の切り分けを容易にする。
*   **ログの活用:** 適切なログレベル設定と、エラーログの監視方法をドキュメント化する。

## 12. ブランド/カスタマイズ

*   **ロゴ・テーマカラーの変更:** セルフホスティングユーザーが自身のブランドに合わせて、アプリケーションのロゴや基本的なテーマカラーを容易に変更できる仕組みを提供する。CSS変数や設定ファイルでの管理を検討する。

## 3. クローリング拒否設定

ユーザーのプライバシー保護とサーバー負荷軽減のために、以下の点を考慮する。

*   **`robots.txt`:** `public` ディレクトリに `robots.txt` を配置し、クローラーに指示を与える。
    *   例: `Disallow: /profile/*`, `Disallow: /settings/*` など、プライベートな情報を含むパスを明示的に拒否する。
*   **メタタグ (`<meta name="robots" content="noindex, nofollow">`):** 特に検索エンジンにインデックスされたくないページ（例: ログインページ、設定ページ、プライベートなプロフィールページ）のHTMLヘッダーにこのメタタグを追加する。
*   **HTTPヘッダー (`X-Robots-Tag`):** Laravelのミドルウェアで、特定のルートやコントローラーに対して `X-Robots-Tag: noindex, nofollow` ヘッダーを付与することも可能。これは `robots.txt` やメタタグよりも強力な指示となる。
*   **認証/認可:** ログインが必要なページは、そもそもクローラーがアクセスできないため、追加の対策は不要な場合が多いが、念のため上記の設定と併用するとより安全。

## 4. 環境構築とデプロイの容易さ

*   **Docker/Docker Compose:** `Dockerfile` と `docker-compose.yml` を提供し、ユーザーがコマンド一つで開発・本番環境を構築できるようにする。
*   **詳細なドキュメント:** `README.md` や専用の `INSTALL.md` などで、前提条件、インストール手順、初期設定、開発サーバーの起動方法などをステップバイステップで明確に記述する。
*   **設定ファイルの外部化:** `.env.example` を充実させ、ユーザーが変更する必要がある設定項目を分かりやすく提示する。

## 5. セキュリティ

*   **Laravelのベストプラクティス:** Laravelの組み込みセキュリティ機能（CSRF保護、XSS対策、SQLインジェクション対策など）を適切に利用していることを確認する。
*   **依存関係の管理:** `composer.json` と `package.json` で使用しているライブラリのバージョンを固定し、定期的なセキュリティアップデートを促す仕組みを検討する。
*   **シークレット管理:** `.env` ファイルの取り扱いについて注意喚起し、本番環境ではより安全な方法を推奨する。

## 6. 運用とメンテナンス

*   **バックアップとリストア:** データベースとアップロードされたファイル（もしあれば）のバックアップ方法、およびリストア手順をドキュメント化する。
*   **アップデートパス:** 新しいバージョンへのアップグレード手順を明確に示す。
*   **ログと監視:** Laravelのログ機能が適切に設定されており、エラー発生時に管理者が確認できることを保証する。

## 7. ライセンスと貢献

*   **OSSライセンス:** 適切なオープンソースライセンスを選択し、プロジェクトのルートに `LICENSE` ファイルとして含める。
*   **貢献ガイドライン:** `CONTRIBUTING.md` を作成し、バグ報告、機能提案、プルリクエストの作成方法など、コミュニティからの貢献を促すためのガイドラインを提供する。

## 8. 国際化 (i18n) / 地域化 (l10n)

*   **多言語対応:** 世界中のユーザーが利用することを想定し、UIのテキストやメッセージを多言語化できるようにする。Laravelの多言語機能（`lang` ディレクトリ、`__` ヘルパー関数など）を適切に利用する。
*   **日付・時刻のフォーマット:** ユーザーのロケールに応じた日付・時刻の表示に対応する。
*   **数値・通貨のフォーマット:** 同様に、ロケールに応じた数値や通貨の表示に対応する。

## 9. パフォーマンス最適化

*   **データベースクエリの最適化:** N+1問題の回避、適切なインデックスの利用、Eloquentの遅延ロード/Eagerロードの使い分けなど。
*   **キャッシュの活用:** 頻繁にアクセスされるデータ（設定値、ユーザー情報の一部など）をキャッシュする。Laravelのキャッシュドライバ（Redis, Memcachedなど）の利用を推奨する。
*   **フロントエンドの最適化:** Viteによるアセットのバンドル、ミニファイ、コード分割、画像最適化など。
*   **キューの利用:** 時間のかかる処理（Blueskyからのデータ同期、メール送信など）はキューに投入し、非同期で実行することでユーザー体験を向上させる。

## 10. テストカバレッジとCI/CD

*   **包括的なテスト:** ユニットテスト、フィーチャーテスト、ブラウザテストなど、様々なレベルでのテストを充実させる。
*   **CI/CDの導入推奨:** GitHub ActionsなどのCI/CDツールを利用し、コードの変更が自動的にテストされ、品質が保証される仕組みを推奨する。これにより、コミュニティからの貢献も受け入れやすくなる。

## 11. エラーハンドリングとデバッグ

*   **ユーザーフレンドリーなエラー表示:** ユーザーに分かりやすいエラーメッセージを提供し、デバッグ情報が本番環境で露出しないようにする。
*   **デバッグツールの活用:** Laravel Debugbarなどのデバッグツールを開発環境での利用を推奨し、問題発生時の切り分けを容易にする。
*   **ログの活用:** 適切なログレベル設定と、エラーログの監視方法をドキュメント化する。

## 12. ブランド/カスタマイズ

*   **ロゴ・テーマカラーの変更:** セルフホスティングユーザーが自身のブランドに合わせて、アプリケーションのロゴや基本的なテーマカラーを容易に変更できる仕組みを提供する。CSS変数や設定ファイルでの管理を検討する。