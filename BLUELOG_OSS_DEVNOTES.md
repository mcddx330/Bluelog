# Bluelog OSS開発ノート

このドキュメントは、Bluelogをオープンソースとしてセルフホスティング可能にするための開発に関する検討事項をまとめたものです。

## 1. 管理者機能と全体設定画面

セルフホスティング環境において非常に重要であり、以下の点を考慮する。

*   **管理者フラグ (`is_admin`):** `users` テーブルにブーリアン型のカラム `is_admin` を追加し、管理者権限を持つユーザーを識別できるようにする。
*   **管理者専用のルーティング/ミドルウェア:** 管理者のみがアクセスできるURLパス（例: `/admin/*`）を設け、Laravelのミドルウェアでアクセス制御を行う。
*   **設定項目:**
    *   **招待コード管理:** 招待コードの生成、有効/無効化、使用状況の確認、削除。
    *   **ユーザー管理:** ユーザーの一覧表示、権限変更（管理者/一般ユーザー）、アカウントの有効/無効化、削除。
    *   **システム設定:**
        *   新規ユーザー登録の許可/不許可（招待コードなしでの登録を許可するかどうか）。
        *   Bluesky APIキーの設定（もしアプリケーション内で直接設定が必要な場合）。
        *   システム名、連絡先メールアドレスなど、インスタンス固有の情報。
        *   デフォルトのプライバシー設定（新規登録ユーザーの `is_private` の初期値など）。
    *   **統計情報:** システム全体の利用状況（ユーザー数、投稿数など）のダッシュボード。
*   **実装の考慮事項:**
    *   設定値はデータベースに保存し、キャッシュ機構を利用して高速に読み込めるようにする。
    *   設定変更は、管理者のみが行えるように厳重な認可チェックが必要。

## 2. 複数人グループでの招待コード必須化

既存の招待コードシステムを活用し、以下の点を考慮する。

*   **登録フローの制御:** 管理者が「招待コード必須」の設定を有効にしている場合、新規登録時に招待コードの入力を必須とする。
*   **招待コードのライフサイクル管理:**
    *   有効期限の設定（任意）。
    *   使用回数の制限（例: 1回限り、複数回利用可能）。
    *   使用済み招待コードの自動無効化。
*   **管理画面での可視化:** 管理者が発行した招待コードの一覧、ステータス（未使用、使用済み、期限切れ）、使用ユーザー、発行日時などを確認できるようにする。

## 3. クローリング拒否設定

ユーザーのプライバシー保護とサーバー負荷軽減のために、以下の点を考慮する。

*   **`robots.txt`:** `public` ディレクトリに `robots.txt` を配置し、クローラーに指示を与える。
    *   例: `Disallow: /profile/*`, `Disallow: /settings/*` など、プライベートな情報を含むパスを明示的に拒否する。
*   **メタタグ (`<meta name="robots" content="noindex, nofollow">`):** 特に検索エンジンにインデックスされたくないページ（例: ログインページ、設定ページ、プライベートなプロフィールページ）のHTMLヘッダーにこのメタタグを追加する。
*   **HTTPヘッダー (`X-Robots-Tag`):** Laravelのミドルウェアで、特定のルートやコントローラーに対して `X-Robots-Tag: noindex, nofollow` ヘッダーを付与することも可能。これは `robots.txt` やメタタグよりも強力な指示となる。
*   **認証/認可:** ログインが必要なページは、そもそもクローラーがアクセスできないため、追加の対策は不要な場合が多いが、念のため上記の設定と併用するとより安全。

## 4. 環境構築とデプロイの容易さ

*   **Docker/Docker Compose:** `Dockerfile` と `docker-compose.yml` を提供し、ユーザーがコマンド一つで開発・本番環境を構築できるようにする。
*   **詳細なドキュメント:** `README.md` や専用の `INSTALL.md` などで、前提条件、インストール手順、初期設定、開発サーバーの起動方法などをステップバイステップで明確に記述する。
*   **設定ファイルの外部化:** `.env.example` を充実させ、ユーザーが変更する必要がある設定項目を分かりやすく提示する。

## 5. セキュリティ

*   **Laravelのベストプラクティス:** Laravelの組み込みセキュリティ機能（CSRF保護、XSS対策、SQLインジェクション対策など）を適切に利用していることを確認する。
*   **依存関係の管理:** `composer.json` と `package.json` で使用しているライブラリのバージョンを固定し、定期的なセキュリティアップデートを促す仕組みを検討する。
*   **シークレット管理:** `.env` ファイルの取り扱いについて注意喚起し、本番環境ではより安全な方法を推奨する。

## 6. 運用とメンテナンス

*   **バックアップとリストア:** データベースとアップロードされたファイル（もしあれば）のバックアップ方法、およびリストア手順をドキュメント化する。
*   **アップデートパス:** 新しいバージョンへのアップグレード手順を明確に示す。
*   **ログと監視:** Laravelのログ機能が適切に設定されており、エラー発生時に管理者が確認できることを保証する。

## 7. ライセンスと貢献

*   **OSSライセンス:** 適切なオープンソースライセンスを選択し、プロジェクトのルートに `LICENSE` ファイルとして含める。
*   **貢献ガイドライン:** `CONTRIBUTING.md` を作成し、バグ報告、機能提案、プルリクエストの作成方法など、コミュニティからの貢献を促すためのガイドラインを提供する。

## 8. 国際化 (i18n) / 地域化 (l10n)

*   **多言語対応:** 世界中のユーザーが利用することを想定し、UIのテキストやメッセージを多言語化できるようにする。Laravelの多言語機能（`lang` ディレクトリ、`__` ヘルパー関数など）を適切に利用する。
*   **日付・時刻のフォーマット:** ユーザーのロケールに応じた日付・時刻の表示に対応する。
*   **数値・通貨のフォーマット:** 同様に、ロケールに応じた数値や通貨の表示に対応する。

## 9. パフォーマンス最適化

*   **データベースクエリの最適化:** N+1問題の回避、適切なインデックスの利用、Eloquentの遅延ロード/Eagerロードの使い分けなど。
*   **キャッシュの活用:** 頻繁にアクセスされるデータ（設定値、ユーザー情報の一部など）をキャッシュする。Laravelのキャッシュドライバ（Redis, Memcachedなど）の利用を推奨する。
*   **フロントエンドの最適化:** Viteによるアセットのバンドル、ミニファイ、コード分割、画像最適化など。
*   **キューの利用:** 時間のかかる処理（Blueskyからのデータ同期、メール送信など）はキューに投入し、非同期で実行することでユーザー体験を向上させる。

## 10. テストカバレッジとCI/CD

*   **包括的なテスト:** ユニットテスト、フィーチャーテスト、ブラウザテストなど、様々なレベルでのテストを充実させる。
*   **CI/CDの導入推奨:** GitHub ActionsなどのCI/CDツールを利用し、コードの変更が自動的にテストされ、品質が保証される仕組みを推奨する。これにより、コミュニティからの貢献も受け入れやすくなる。

## 11. エラーハンドリングとデバッグ

*   **ユーザーフレンドリーなエラー表示:** ユーザーに分かりやすいエラーメッセージを提供し、デバッグ情報が本番環境で露出しないようにする。
*   **デバッグツールの活用:** Laravel Debugbarなどのデバッグツールを開発環境での利用を推奨し、問題発生時の切り分けを容易にする。
*   **ログの活用:** 適切なログレベル設定と、エラーログの監視方法をドキュメント化する。

## 12. ブランド/カスタマイズ

*   **ロゴ・テーマカラーの変更:** セルフホスティングユーザーが自身のブランドに合わせて、アプリケーションのロゴや基本的なテーマカラーを容易に変更できる仕組みを提供する。CSS変数や設定ファイルでの管理を検討する。