# Bluelog データ同期・統計集計バッチ設計

## 1. 概要

このドキュメントは、Bluelogの統計機能（ステータス画面）を実現するために、バックグラウンドで定期的に実行されるデータ同期・集計処理の設計を定義する。

主な目的は、Bluesky APIから各ユーザーの最新アクティビティ（投稿、いいね等）を取得し、日別の統計データとして `daily_stats` テーブルに集計・保存することである。

## 2. コンソールコマンド仕様

- **コマンド名:** `status:aggregate`
- **ファイルパス:** `app/Console/Commands/AggregateStatusCommand.php`
- **責務:** Bluelogに登録されている全ユーザーを対象に、Bluesky APIから未取得の活動履歴を取得し、日別の統計情報としてデータベースに保存する。

## 3. 処理フロー詳細

コマンドが実行されると、以下のステップで処理が進められる。

### ステップ1: 対象ユーザーの取得

Bluelogのデータベースに登録されている全てのユーザーを `users` テーブルから取得する。

### ステップ2: ユーザーごとのループ処理

取得した全ユーザーに対して、一人ずつ以下の同期処理を実行する。

### ステップ3: Bluesky APIクライアントの準備

1.  対象ユーザーの `access_jwt` と `refresh_jwt` を `users` テーブルから取得する。
2.  アクセストークンの有効性を確認 (`check` メソッド)。
3.  もしアクセストークンが無効であれば、リフレッシュトークンを使ってトークンを更新 (`refreshSession`) し、新しいトークンを `users` テーブルに保存する。
4.  有効なトークンで認証されたAPIクライアントを準備する。

### ステップ4: 投稿フィードの取得と集計

1.  **差分取得:** `users` テーブルに保存されている `post_fetch_cursor` を利用し、`getAuthorFeed` APIを呼び出す。これにより、前回取得した時点からの新しい投稿のみを効率的に取得する。
    - **カーソルとAPIの挙動に関する補足:**
        - `getAuthorFeed` APIは、`cursor` パラメータが指定されない場合や `null` の場合、最新の投稿から順にデータを返す。
        - `status:aggregate` コマンドの投稿取得処理は `do-while` ループで実装されており、最低1回はAPI呼び出しが実行される。これは、新しい投稿がないかを確認するため、およびカーソルベースのページネーションの特性上、避けられない挙動である。
        - 既に全ての投稿が取得済みであっても、この最初のAPI呼び出しは発生し、APIが既存の投稿を返す場合がある。しかし、データベースへの保存には `Post::updateOrCreate()` が使用されているため、重複してデータが追加されることはなく、既存のデータは更新される。
2.  **データ集計:** 取得した新しい投稿を一つずつ分析し、日付ごとの活動内容をメモリ上の一時配列に集計する。
    - `createdAt` (投稿日時) をもとに、活動日を特定する。
    - `record` の内容を解析し、投稿の種類を判別する。
        - 通常の投稿 → `posts_count` をインクリメント
        - リプライ (`reply` オブジェクトが存在) → `replies_count` をインクリメント
        - リポスト (`repost` オブジェクトが存在) → `reposts_count` をインクリメント
        - メンション (`facets` 内に `mention` が存在) → `mentions_count` をインクリメント

### ステップ5: 投稿に紐づくメディア情報の取得と保存

投稿データに画像や動画などのメディア情報が含まれる場合、その詳細を抽出し、`media` テーブルに保存する。

1.  **メディア情報の検出**: 投稿データ (`$item['post']['embed']`) の `$type` を確認し、`app.bsky.embed.images#view` または `app.bsky.embed.video#view` であるかを判別する。
2.  **メディア情報の抽出**:
    *   **画像の場合 (`app.bsky.embed.images#view`)**:
        `$item['post']['embed']['images']` 配列をループし、各画像について以下の情報を抽出する。
        *   `type`: `'image'`
        *   `url`: `fullsize` URL (Bluesky CDNから直接取得可能なURL)
        *   `thumbnail_url`: `thumb` URL (Bluesky CDNから直接取得可能なサムネイルURL)
        *   `alt_text`: `alt` (代替テキスト)
        *   `aspect_ratio_width`, `aspect_ratio_height`: アスペクト比 (存在する場合)
    *   **動画の場合 (`app.bsky.embed.video#view`)**:
        動画は通常1つなので、直接以下の情報を抽出する。
        *   `type`: `'video'`
        *   `url`: `playlist` URL (Bluesky CDNから直接取得可能な動画再生リストURL)
        *   `thumbnail_url`: `thumbnail` URL (Bluesky CDNから直接取得可能なサムネイルURL)
        *   `alt_text`: `alt` (キャプション)
        *   `aspect_ratio_width`, `aspect_ratio_height`: アスペクト比 (存在する場合)
3.  **`media` テーブルへの保存**: 抽出したメディア情報を、`Post` モデルとのリレーションを通じて `media` テーブルに保存する。メディアのバイナリデータはローカルに保存せず、Bluesky CDNのURLを直接利用する。

### ステップ6: いいね履歴の取得と集計

1.  **差分取得:** `users` テーブルの `like_fetch_cursor` を利用し、`listRecords` API (`collection` は `app.bsky.feed.like`) を呼び出す。
2.  **データ集計:** 取得した新しい「いいね」レコードを一つずつ分析する。
    - `createdAt` (いいね日時) をもとに、活動日を特定する。
    - 対応する日付の `likes_count` をインクリメントする。

### ステップ7: データベースへの保存

1.  ユーザー一人分の集計が完了したら、メモリ上に保持している日別の統計データを `daily_stats` テーブルに保存する。
2.  `DailyStat::updateOrCreate()` を使用し、`['did' => $user->did, 'date' => $date]` を複合キーとして、データの登録・更新を行う。
    - レコードが新規作成される場合は、集計したカウントをそのまま保存する。
    - レコードが既に存在する場合は、既存のカウント値に今回集計した値を加算して更新する。

## 4. 自動実行（スケジューリング）

作成した `status:aggregate` コマンドは、`app/Console/Kernel.php` の `schedule` メソッドに登録し、cron（クーロン）によって定期的に自動実行されるように設定する。

- **実行頻度（案）:** 1時間ごと (`hourly()`) または 1日1回 (`daily()`)。アプリケーションの運用方針に応じて決定する。

## 5. 関連データモデル

- `app/Models/User.php`
- `app/Models/DailyStat.php`
- `app/Models/Media.php` (新規追加)
- `database/migrations/*_create_media_table.php` (新規追加)

---

# ポストエクスポート機能設計

## 1. 概要

本機能は、ユーザーが自身のBlueskyポストデータをエクスポートすることを目的とします。エクスポートされるデータは、各ポストの識別情報、Bluesky上のURL、投稿日時、および整形されたポストテキストを含みます。これにより、ユーザーは自身の投稿履歴をオフラインで管理したり、他のアプリケーションで利用したりすることが可能になります。

## 2. エクスポート対象データ

以下の情報を各ポストについてエクスポートします。

### 2.1. ポストのCID (Content ID)

*   **データソース**: `posts` テーブルの `cid` カラム。
*   **形式**: 文字列。
*   **説明**: Blueskyネットワーク上でのポストの一意な識別子です。

### 2.2. 実際のBlueskyのURL

*   **データソース**: Blueskyの公式Webインターフェースにおけるポストのパーマリンク。
*   **形式**: URL文字列。
*   **生成方法**:
    *   BlueskyのポストURLは通常 `https://bsky.app/profile/{ユーザーハンドル}/post/{rkey}` の形式を取ります。
    *   `{ユーザーハンドル}` は、ポストを投稿したユーザーのBlueskyハンドル（例: `example.bsky.social`）です。これは `users` テーブルから取得できます。
    *   `{rkey}` は、ポストのレコードキーです。これは `posts` テーブルの `rkey` カラムから取得できます。
    *   したがって、URLは `https://bsky.app/profile/{user_handle}/post/{post_rkey}` のように動的に生成します。

### 2.3. 投稿日時

*   **データソース**: `posts` テーブルの `posted_at` カラム。
*   **形式**: 日時文字列（例: `YYYY-MM-DD HH:MM:SS`）。
*   **説明**: ポストがBlueskyに投稿された正確な日時です。タイムゾーン情報を含めるか、UTCで統一するかを検討します。

### 2.4. 実際のポストテキスト（メンション解決済み）

*   **データソース**: `posts` テーブルの `text` カラムと、関連する `mentions` テーブルのデータ。
*   **形式**: 文字列。
*   **説明**: ポストの本文テキストです。特に、メンション（`@`ユーザー名）が含まれる場合、そのメンションがBlueskyのハンドル形式（例: `@example.bsky.social`）で表示されるように解決します。
*   **メンション解決方法**:
    1.  `posts` テーブルの `text` カラムから元のテキストを取得します。
    2.  `mentions` テーブルから、当該ポストに関連するメンションエンティティ（`start_index`, `end_index`, `did`, `handle` など）を取得します。
    3.  元のテキストの指定された範囲（`start_index`から`end_index`）を、`@`とメンション先のユーザーハンドル（`handle`）に置き換えます。
    4.  複数のメンションがある場合は、インデックスの降順（テキストの末尾から先頭に向かって）に置換処理を行うことで、インデックスのずれを防ぎます。

## 3. エクスポート形式

初期実装では、以下の形式を検討します。

*   **CSV (Comma Separated Values)**:
    *   各行が1つのポストを表し、各カラムが上記2.1〜2.4のデータに対応します。
    *   ヘッダー行を含めます。
    *   カンマや改行を含むテキストデータは、ダブルクォーテーションで囲むなどの適切なエスケープ処理を行います。
    *   ファイル名例: `bluelog_posts_export_YYYYMMDD_HHMMSS.csv`

## 4. UI/UX (ユーザーインターフェース)

*   **場所**: 設定画面 (`resources/views/settings/index.blade.php` を想定) に「データエクスポート」セクションを設けます。
*   **構成**:
    *   セクションタイトル: 「データエクスポート」
    *   説明文: 「Bluelogに保存されているあなたのBlueskyポストデータをCSV形式でエクスポートできます。」
    *   エクスポートボタン: 「ポストをエクスポート」
*   **操作**: エクスポートボタンをクリックすると、エクスポート処理がバックグラウンドで開始され、完了後にCSVファイルがダウンロードされます。処理に時間がかかる場合は、プログレス表示や完了通知を検討します。

## 5. 考慮事項

### 5.1. データ量とパフォーマンス

*   エクスポート対象のポスト数が多い場合、処理に時間がかかったり、メモリを大量に消費したりする可能性があります。
*   大量データのエクスポートには、ストリーミングダウンロードや、非同期処理（キュー）の利用を検討します。

### 5.2. エラーハンドリング

*   エクスポート処理中にエラーが発生した場合（例: データベース接続エラー、メンション解決失敗）、ユーザーに適切なフィードバックを提供します。

### 5.3. セキュリティ

*   生成されるBluesky URLは公開情報ですが、ユーザーのプライバシーに関わる情報（特に非公開ポストなど）を誤ってエクスポートしないよう、エクスポート対象の範囲を明確にします。

### 5.4. メンション解決の正確性

*   Blueskyのテキストエンティティは複雑な場合があるため、メンションの`start_index`と`end_index`が正確にテキストのバイトオフセットに対応していることを確認し、マルチバイト文字の扱いに注意します。