# Bluelog データ同期・統計集計バッチ設計

## 1. 概要

このドキュメントは、Bluelogの統計機能（ステータス画面）を実現するために、バックグラウンドで定期的に実行されるデータ同期・集計処理の設計を定義する。

主な目的は、Bluesky APIから各ユーザーの最新アクティビティ（投稿、いいね等）を取得し、日別の統計データとして `daily_stats` テーブルに集計・保存することである。

## 2. コンソールコマンド仕様

- **コマンド名:** `status:aggregate`
- **ファイルパス:** `app/Console/Commands/AggregateStatusCommand.php`
- **責務:** Bluelogに登録されている全ユーザーを対象に、Bluesky APIから未取得の活動履歴を取得し、日別の統計情報としてデータベースに保存する。
- **オプション:**
    *   `--did=`: 集計対象ユーザーのDIDを指定します。指定しない場合、全てのユーザーが対象となります。
    *   `--full-sync`: 既存のカーソルを無視し、Blueskyからユーザーの全データを強制的に再取得します。このオプションを使用すると、Bluelogに保存されている当該ユーザーの既存の投稿、いいね、メディア、ハッシュタグ、日別統計データは一度削除され、Bluesky上のデータに基づいて再構築されます。Bluelog側で削除されたデータも、Bluesky上に存在すれば復活します。
    *   `--force`: `--full-sync` オプションと併用することで、実行時の確認プロンプトをスキップします。バッチ処理など、非対話的な環境での実行時に使用します。

## 3. 処理フロー詳細

コマンドが実行されると、以下のステップで処理が進められる。

### ステップ1: 対象ユーザーの取得

Bluelogのデータベースに登録されている全てのユーザーを `users` テーブルから取得する。

### ステップ2: ユーザーごとのループ処理

取得した全ユーザーに対して、一人ずつ以下の同期処理を実行する。

### 3.x. 強制的な全件再取得オプション (--full-sync) の挙動
`--full-sync` オプションが指定された場合、通常の差分同期とは異なり、以下の特別な処理が実行されます。

*   **既存データの削除**: 処理開始前に、当該ユーザーに関連する `posts`、`likes`、`daily_stats` テーブルのデータが全て削除されます。`posts` の削除に伴い、外部キー制約 (`onDelete('cascade')`) により、関連する `media` および `hashtags` データも自動的にカスケード削除されます。
*   **カーソル無視と全件取得**: `users` テーブルに保存されている `last_synced_post_cid` および `last_synced_like_cid` は無視され、Bluesky APIから利用可能な最も古いデータから順に全件取得が試みられます。
*   **データ復活**: Bluelog側でユーザーが手動で削除した投稿やいいねも、Bluesky上にまだ存在していれば、この全件再取得によってBluelogに再度記録されます。
*   **カーソル更新**: 全件再取得が完了した後、`last_synced_post_cid` および `last_synced_like_cid` は、今回取得した最新の投稿およびいいねのCIDで更新されます。これにより、次回以降の同期は新しいカーソルから差分取得として機能します。
*   **CLIでの警告**: CLIから `--full-sync` オプションを実行する際、`--force` オプションが指定されていない場合は、データ削除と再構築の重大性を警告するメッセージが表示され、ユーザーに続行の確認を求めます。

### ステップ3: Bluesky APIクライアントの準備

1.  対象ユーザーの `access_jwt` と `refresh_jwt` を `users` テーブルから取得する。
2.  アクセストークンの有効性を確認 (`check` メソッド)。
3.  もしアクセストークンが無効であれば、リフレッシュトークンを使ってトークンを更新 (`refreshSession`) し、新しいトークンを `users` テーブルに保存する。
4.  有効なトークンで認証されたAPIクライアントを準備する。

### ステップ4: 投稿フィードの取得と集計

1.  **差分取得:**
    *   **初回取得時:** `users` テーブルの `last_synced_post_cid` が `null` の場合、`getAuthorFeed` APIを呼び出し、最新の投稿から順に取得を開始する。
    *   **2回目以降の取得時:** `users` テーブルの `last_synced_post_cid` に保存されているCID（前回同期時に取得した最新投稿のCID）を基準として、それ以降の新しい投稿のみを取得する。
        *   `getAuthorFeed` APIを呼び出し、取得した投稿を順次処理する。
        *   取得した投稿の `cid` が `last_synced_post_cid` と一致した場合、それ以上古い投稿は既に同期済みと判断し、APIからの取得を打ち切る。これにより、不要なAPI呼び出しとデータ処理を削減する。
    *   **カーソルとAPIの挙動に関する補足:**
        *   `getAuthorFeed` APIは、`cursor` パラメータが指定されない場合や `null` の場合、最新の投稿から順にデータを返す。
        *   `status:aggregate` コマンドの投稿取得処理は `do-while` ループで実装されており、最低1回はAPI呼び出しが実行される。これは、新しい投稿がないかを確認するため、およびカーソルベースのページネーションの特性上、避けられない挙動である。
        *   データベースへの保存には `Post::updateOrCreate()` が使用されているため、重複してデータが追加されることはなく、既存のデータは更新される。
    *   **`last_synced_post_cid` の更新:** 投稿の取得と保存が完了した後、今回取得した投稿の中で最も新しい `cid` を `users` テーブルの `last_synced_post_cid` に保存する。
    *   **補足:** `--full-sync` オプションが指定された場合は、この差分取得ロジックは適用されず、全件取得が実行されます。
2.  **データ集計:** 取得した新しい投稿を一つずつ分析し、日付ごとの活動内容をメモリ上の一時配列に集計する。
    - `createdAt` (投稿日時) をもとに、活動日を特定する。
    - `record` の内容を解析し、投稿の種類を判別する。
        - 通常の投稿 → `posts_count` をインクリメント
        - リプライ (`reply` オブジェクトが存在) → `replies_count` をインクリメント
        - リポスト (`repost` オブジェクトが存在) → `reposts_count` をインクリメント
        - リプライ (`facets` 内に `reply` が存在) → `replies_count` をインクリメント

#### ハッシュタグのデータ永続化における整合性保証

ハッシュタグの保存処理において、データベースのUNIQUE制約違反を回避するため、`Hashtag::create()` の代わりに `Hashtag::updateOrCreate()` を使用します。これにより、ハッシュタグが既に存在する場合は更新され、存在しない場合は新規作成されるため、冪等な操作が保証され、データ整合性が維持されます.

### ステップ5: 投稿に紐づくメディア情報の取得と保存

投稿データに画像や動画などのメディア情報が含まれる場合、その詳細を抽出し、`media` テーブルに保存する。

1.  **メディア情報の検出**: 投稿データ (`$item['post']['embed']`) の `$type` を確認し、`app.bsky.embed.images#view` または `app.bsky.embed.video#view` であるかを判別する。
2.  **メディア情報の抽出**:
    *   **画像の場合 (`app.bsky.embed.images#view`)**:
        `$item['post']['embed']['images']` 配列をループし、各画像について以下の情報を抽出する。
        *   `type`: `'image'`
        *   `url`: `fullsize` URL (Bluesky CDNから直接取得可能なURL)
        *   `thumbnail_url`: `thumb` URL (Bluesky CDNから直接取得可能なサムネイルURL)
        *   `alt_text`: `alt` (代替テキスト)
        *   `aspect_ratio_width`, `aspect_ratio_height`: アスペクト比 (存在する場合)
    *   **動画の場合 (`app.bsky.embed.video#view`)**:
        動画は通常1つなので、直接以下の情報を抽出する。
        *   `type`: `'video'`
        *   `url`: `playlist` URL (Bluesky CDNから直接取得可能な動画再生リストURL)
        *   `thumbnail_url`: `thumbnail` URL (Bluesky CDNから直接取得可能なサムネイルURL)
        *   `alt_text`: `alt` (キャプション)
        *   `aspect_ratio_width`, `aspect_ratio_height`: アスペクト比 (存在する場合)
3.  **`media` テーブルへの保存**: 抽出したメディア情報を、`Post` モデルとのリレーションを通じて `media` テーブルに保存する。メディアのバイナリデータはローカルに保存せず、Bluesky CDNのURLを直接利用する。

### ステップ6: いいね履歴の取得と集計

1.  **差分取得:**
    *   **初回取得時:** `users` テーブルの `last_synced_like_cid` が `null` の場合、`listRecords` API (`collection` は `app.bsky.feed.like`) を呼び出し、最新のいいねから順に取得を開始する。
    *   **2回目以降の取得時:** `users` テーブルの `last_synced_like_cid` に保存されているCID（前回同期時に取得した最新いいねのCID）を基準として、それ以降の新しいいいねのみを取得する。
        *   `listRecords` APIを呼び出し、取得したいを順次処理する。
        *   取得したいの `cid` が `last_synced_like_cid` と一致した場合、それ以上古いいいねは既に同期済みと判断し、APIからの取得を打ち切る。これにより、不要なAPI呼び出しとデータ処理を削減する。
    *   **`last_synced_like_cid` の更新:** いいねの取得と保存が完了した後、今回取得したいの中で最も新しい `cid` を `users` テーブルの `last_synced_like_cid` に保存する。
    *   **補足:** `--full-sync` オプションが指定された場合は、この差分取得ロジックは適用されず、全件取得が実行されます。
2.  **データ集計:** 取得した新しい「いいね」レコードを一つずつ分析する。
    - `createdAt` (いいね日時) をもとに、活動日を特定する。
    - 対応する日付の `likes_count` をインクリメントする。

### ステップ7: データベースへの保存

1.  ユーザー一人分の集計が完了したら、メモリ上に保持している日別の統計データを `daily_stats` テーブルに保存する。
2.  `DailyStat::updateOrCreate()` を使用し、`['did' => $user->did, 'date' => $date]` を複合キーとして、データの登録・更新を行う。
    - レコードが新規作成される場合は、集計したカウントをそのまま保存する。
    - レコードが既に存在する場合は、既存のカウント値に今回集計した値を加算して更新する。

## 4. 自動実行（スケジューリング）

作成した `status:aggregate` コマンドは、`app/Console/Kernel.php` の `schedule` メソッドに登録し、cron（クーロン）によって定期的に自動実行されるように設定する。

- **実行頻度（案）:** 1時間ごと (`hourly()`) または 1日1回 (`daily()`)。アプリケーションの運用方針に応じて決定する。

## 5. 関連データモデル

- `app/Models/User.php`
- `app/Models/DailyStat.php`
- `app/Models/Media.php` (新規追加)
- `database/migrations/*_create_media_table.php` (新規追加)

### `users` テーブル定義

| カラム名                   | 型             | 説明                                                                 |
|------------------------|---------------|--------------------------------------------------------------------|
| `did`                  | `string` (PK) | Blueskyの分散型識別子 (Decentralized Identifier)。主キー。                     |
| `handle`               | `string`      | ユーザーハンドル (@example.bsky.social)                                    |
| `display_name`         | `string`      | 表示名                                                                |
| `description`          | `text`        | プロフィール説明文                                                          |
| `avatar_url`           | `string`      | アバター画像のURL                                                         |
| `banner_url`           | `string`      | バナー画像のURL                                                          |
| `followers_count`      | `integer`     | フォロワー数                                                             |
| `following_count`      | `integer`     | フォロー数                                                              |
| `registered_at`        | `datetime`    | Blueskyへのアカウント登録日時 (`app.bsky.actor.getProfile` の `createdAt` を格納) |
| `last_login_at`        | `datetime`    | Bluelogへの最終ログイン日時                                                  |
| `last_fetched_at`      | `datetime`    | バッチ処理などで最後に投稿やいいねを取得した日時                                           |
| `access_jwt`           | `text`        | Bluesky APIへのアクセストークン                                              |
| `refresh_jwt`          | `text`        | Bluesky APIへのリフレッシュトークン                                            |
| `last_synced_post_cid` | `string`      | 最後に同期した投稿のCID                                                      |
| `last_synced_like_cid` | `string`      | 最後に同期した「いいね」のCID                                                   |
| `is_private`           | `boolean`     | プロフィールの公開・非公開フラグ (デフォルト: `false`)                                  |
| `is_fetching`          | `boolean`     | データ取得中フラグ (デフォルト: `false`)                                         |
| `created_at`           | `timestamp`   | レコード作成日時。                                                          |
| `updated_at`           | `timestamp`   | レコード更新日時。                                                          |

`User` モデルには、`DailyStat` モデルとの `HasMany` リレーションである `dailyStats()` メソッドが追加されました。これにより、ユーザーに関連する日別統計データを効率的に取得・管理できます。

---

# ポストエクスポート機能設計

## 1. 概要

本機能は、ユーザーが自身のBlueskyポストデータをエクスポートすることを目的とします。エクスポートされるデータは、各ポストの識別情報、Bluesky上のURL、投稿日時、および整形されたポストテキストを含みます。これにより、ユーザーは自身の投稿履歴をオフラインで管理したり、他のアプリケーションで利用したりすることが可能になります。

## 2. エクスポート対象データ

以下の情報を各ポストについてエクスポートします。

### 2.1. ポストのCID (Content ID)

*   **データソース**: `posts` テーブルの `cid` カラム。
*   **形式**: 文字列。
*   **説明**: Blueskyネットワーク上でのポストの一意な識別子です。

### 2.2. 実際のBlueskyのURL

*   **データソース**: Blueskyの公式Webインターフェースにおけるポストのパーマリンク。
*   **形式**: URL文字列。
*   **生成方法**:
    *   BlueskyのポストURLは通常 `https://bsky.app/profile/{ユーザーハンドル}/post/{rkey}` の形式を取ります。
    *   `{ユーザーハンドル}` は、ポストを投稿したユーザーのBlueskyハンドル（例: `example.bsky.social`）です。これは `users` テーブルから取得できます。
    *   `{rkey}` は、ポストのレコードキーです。これは `posts` テーブルの `rkey` カラムから取得できます。
    *   したがって、URLは `https://bsky.app/profile/{user_handle}/post/{post_rkey}` のように動的に生成します。

### 2.3. 投稿日時

*   **データソース**: `posts` テーブルの `posted_at` カラム。
*   **形式**: 日時文字列（例: `YYYY-MM-DD HH:MM:SS`）。
*   **説明**: ポストがBlueskyに投稿された正確な日時です。タイムゾーン情報を含めるか、UTCで統一するかを検討します。

### 2.4. 実際のポストテキスト（リプライ解決済み）

*   **データソース**: `posts` テーブルの `text` カラムと、関連する `replies` テーブルのデータ。
*   **形式**: 文字列。
*   **説明**: ポストの本文テキストです。特に、リプライ（`@`ユーザー名）が含まれる場合、そのリプライがBlueskyのハンドル形式（例: `@example.bsky.social`）で表示されるように解決します。
*   **リプライ解決方法**:
    1.  `posts` テーブルの `text` カラムから元のテキストを取得します。
    2.  `replies` テーブルから、当該ポストに関連するリプライエンティティ（`start_index`, `end_index`, `did`, `handle` など）を取得します。
    3.  元のテキストの指定された範囲（`start_index`から`end_index`）を、`@`とリプライ先のユーザーハンドル（`handle`）に置き換えます。
    4.  複数のリプライがある場合は、インデックスの降順（テキストの末尾から先頭に向かって）に置換処理を行うことで、インデックスのずれを防ぎます。

## 3. エクスポート形式

初期実装では、以下の形式を検討します。

*   **CSV (Comma Separated Values)**:
    *   各行が1つのポストを表し、各カラムが上記2.1〜2.4のデータに対応します。
    *   ヘッダー行を含めます。
    *   カンマや改行を含むテキストデータは、ダブルクォーテーションで囲むなどの適切なエスケープ処理を行います。
    *   ファイル名例: `bluelog_posts_export_YYYYMMDD_HHMMSS.csv`

## 4. UI/UX (ユーザーインターフェース)

*   **場所**: 設定画面 (`resources/views/settings/index.blade.php` を想定) に「データエクスポート」セクションを設けます。
*   **構成**:
    *   セクションタイトル: 「データエクスポート」
    *   説明文: 「Bluelogに保存されているあなたのBlueskyポストデータをCSV形式でエクスポートできます。」
    *   エクスポートボタン: 「ポストをエクスポート」
*   **操作**: エクスポートボタンをクリックすると、エクスポート処理がバックグラウンドで開始され、完了後にCSVファイルがダウンロードされます。処理に時間がかかる場合は、プログレス表示や完了通知を検討します。

## 5. 考慮事項

### 5.1. データ量とパフォーマンス

*   エクスポート対象のポスト数が多い場合、処理に時間がかかったり、メモリを大量に消費したりする可能性があります。
*   大量データのエクスポートには、ストリーミングダウンロードや、非同期処理（キュー）の利用を検討します。

### 5.2. エラーハンドリング

*   エクスポート処理中にエラーが発生した場合（例: データベース接続エラー、リプライ解決失敗）、ユーザーに適切なフィードバックを提供します。

### 5.3. セキュリティ

*   生成されるBluesky URLは公開情報ですが、ユーザーのプライバシーに関わる情報（特に非公開ポストなど）を誤ってエクスポートしないよう、エクスポート対象の範囲を明確にします。

### 5.4. リプライ解決の正確性

*   Blueskyのテキストエンティティは複雑な場合があるため、リプライの`start_index`と`end_index`が正確にテキストのバイトオフセットに対応していることを確認し、マルチバイト文字の扱いにも注意します。
