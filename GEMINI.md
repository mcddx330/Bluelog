# Bluelog プロジェクトガイド (Gemini向け)

このドキュメントは、Bluelogプロジェクトにおけるあなたの作業を支援するためのガイドです。
以下の指示を厳守し、効率的かつ安全な開発を心がけてください。

## 1. プロジェクトの基本情報

### 1.1. 目的と概要
Bluelogは、Blueskyユーザーの投稿や「いいね」を収集し、Twilogのように時系列で閲覧できるサービスです。ユーザーは自身のBlueskyアカウントを連携することで、活動履歴を管理・分析できます。

### 1.2. 主要技術スタック
*   **バックエンド:** PHP 8.2+, Laravel 12.x
*   **フロントエンド:** Vite 5.x, Tailwind CSS
*   **データベース:** SQLite (開発時デフォルト)
*   **Bluesky連携ライブラリ:** `revolution/laravel-bluesky`, `potibm/phluesky`

## 2. 開発環境と操作コマンド

### 2.1. セットアップ
プロジェクト開始時、または依存関係の変更があった場合は、以下のコマンドを実行してください。
*   `composer install`
*   `npm install`
*   `cp .env.example .env`
*   `php artisan key:generate`
*   `touch database/database.sqlite`
*   `php artisan migrate`

### 2.2. 開発サーバーの起動
以下のコマンドで、開発に必要な全てのサーバーを起動できます。
*   `npm run dev` (これは `composer.json` の `dev` スクリプトで定義されている `php artisan serve`, `php artisan queue:listen`, `php artisan pail`, `vite` を同時に実行します)

### 2.3. テストと検証
*   **テスト実行:** `php artisan test` または `vendor/bin/phpunit`
*   **リンティング/型チェック:** プロジェクトに設定されている場合は、`npm run lint` や `php artisan analyse` などのコマンドを使用してください。

## 3. コード規約とユーザー設定

### 3.1. 言語とコミュニケーション
*   ユーザーとのやり取りは**日本語**で行ってください。

### 3.2. コードスタイル
*   **変数名:** **スネークケース (`snake_case`)** を厳守してください。
*   **メソッド名:** キャメルケース (`camelCase`) を使用してください。
*   **定数名:** 全て大文字 (`ALL_CAPS`) を使用してください。
*   **数値の加算・減算・乗算・除算:** `A += B`, `C -= D` `E *= F` `G /= H` の形式を使用してください。
*   **PHPの型ヒント:** メソッドの引数と返り値には、可能な限り型を明記してください。
*   **数値表示:** 一般的に表示される数値は、特別な事情がない限り、 `number_format()` にてカンマ区切りにしてください。

## 4. Bluesky連携とデータ管理の重要事項

### 4.1. 認証とトークン管理 (最重要セキュリティ項目)
*   **`refresh_jwt`:** データベース (`users` テーブル) に**暗号化して**保存されます。ユーザーがログアウトしてもデータ同期を継続するために使用されます。
*   **`access_jwt`:** ユーザーのWebセッション中にサーバーサイドのセッションに保存されます。クライアントサイドに露出させないでください。
*   **トークンの自動更新:** `access_jwt` が期限切れの場合、`refresh_jwt` を使用して自動的に更新されます。このロジックは `AggregateStatusCommand` や `BlueskyController` に実装されています。
*   **セキュリティ警告:** **認証情報をURLパラメータとして渡すことは絶対に禁止です。** ログへの露出や傍受リスクがあるため、このプロジェクトでは採用しません。

### 4.2. データ取得と同期 (`status:aggregate` コマンド)
*   **トリガー:** ユーザーログイン時、または定期的なバックグラウンドプロセス (`status:aggregate` Artisanコマンド) によって実行されます。
*   **処理内容:**
    *   ユーザーのBlueskyプロフィール、投稿、いいねを取得します。
    *   `is_fetching` フラグ (`users` テーブル) を使用して、データ取得中のユーザーをマークします。
    *   Bluesky APIの `cursor` を利用し、効率的な差分更新を行います。
    *   取得したデータは、`users`, `posts`, `likes`, `media`, `hashtags`, `daily_stats` テーブルに保存されます。
    *   投稿に紐づくメディア（画像、動画）は、Bluesky CDNのURLとして保存され、ローカルには保存されません。
    *   日ごとの統計情報 (`daily_stats`) が集計・更新されます。

### 4.3. プライバシー設定 (`is_private` フラグ)
*   `users` テーブルの `is_private` フラグは、**Bluelogサービス内での表示制御に限定されます。**
*   このフラグは、Bluesky側の「Logged-out visibility」設定とは**連動しません**。ユーザーはBluelogとBlueskyで個別に設定を管理します。
*   `is_private` が `true` の場合、本人以外のユーザーにはプロフィールやコンテンツが表示されません。このチェックは `BlueskyController@showProfile` などで行われます。

### 4.4. データベースの整合性
*   テーブル間の関連性には**外部キー制約**が設定されており、特に `onDelete('cascade')` が多用されています。関連データを削除する際は、この挙動を理解してください。

## 5. 主要機能のロジック概要

*   **投稿検索:** `posts` テーブルの `text` カラムに対する `LIKE '%キーワード%'` による部分一致検索が実装されています。パフォーマンスに影響が出る可能性があるため、将来的な改善（全文検索エンジンの導入など）を検討してください。
*   **投稿ソート:** `posts` テーブルの `posted_at` および生成列 `posted_date_only` を使用してソートが可能です。`posted_date_only` は、日付部分での高速なソートのために導入されています。
*   **データエクスポート:** ユーザーの投稿データをCSV形式でエクスポートする機能があります。大量データの場合、ストリーミングダウンロードが利用されます。
*   **アカウント削除:** ユーザーアカウントを削除すると、`onDelete('cascade')` により、関連する全てのデータ（投稿、いいね、メディア、統計など）がデータベースから自動的に削除されます。

## 6. 運用方針 (サービス稼働初期の招待コード制)

*   サービス稼働初期は、システムの安定性と品質確保のため、ユーザー登録を**招待コード制**とします。
*   これは、段階的なユーザー増加を管理し、動作・負荷チェック、フィードバック収集を目的としています。
*   招待コードは管理者のみが発行し、登録時に必須入力となります。
*   システムの安定性が確認された段階で、招待コード制は解除される可能性があります。

---

このガイドは、あなたがBluelogプロジェクトのタスクを遂行する上で、特に注意すべき点や、プロジェクト固有のルール、重要な実装の詳細をまとめたものです。常にこのガイドを参照し、疑問点があればユーザーに確認してください。
