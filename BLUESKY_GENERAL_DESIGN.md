# Bluelog 全般設計ドキュメント

このドキュメントは、Bluelogアプリケーションの全体的な設計思想、主要機能、技術スタック、および運用に関する基本的な方針をまとめたものです。

## 1. プロジェクト概要と目的

Bluelogは、Blueskyの特定のユーザーの投稿や「いいね」を収集し、Twilogのように時系列で閲覧できるサービスを提供することを目的としています。ユーザーは自身のBlueskyアカウントをBluelogに連携することで、過去の活動履歴を容易に追跡・管理し、より深く理解することが可能になります。

## 2. 主要技術スタック

Bluelogは、Laravelフレームワークを基盤とし、Bluesky API連携ライブラリを活用して構築されています。詳細な技術スタックについては、プロジェクトルートの `GEMINI.md` を参照してください。

## 3. Bluesky連携とデータ管理の概要

Bluelogの核となる機能は、Bluesky APIとのセキュアな連携と、取得したデータの効率的な管理によって実現されます。

### 3.1. 認証とトークン管理

Bluelogは、ユーザーのBlueskyアカウントへのアクセスを許可するため、アクセストークンとリフレッシュトークンを使用します。

*   **リフレッシュトークンの保管:** ユーザーがBluelogにログインした際、取得したリフレッシュトークンはデータベースに**暗号化して**保存されます。これにより、ユーザーがログアウトした後も、バックグラウンドでのデータ同期を継続できます。
*   **アクセストークンの保管:** アクセストークンは、ユーザーのWebセッション中にサーバーサイドのセッションに保存されます。これは、トークンがクライアントサイドに露出するリスクを防ぎ、セキュリティを強化するためです。
*   **トークンの自動更新:** アクセストークンが期限切れになった場合、保存されているリフレッシュトークンを使用して新しいアクセストークンを自動的に取得し、セッションを継続します。この処理は、ユーザーのログインセッション中およびバックグラウンドでのデータ取得処理の両方で行われます。
*   **セキュリティ方針:** 認証情報をURLパラメータとして渡すなど、セキュリティ上の脆弱性となる方法は一切採用しません。

### 3.2. データ取得と永続化

Bluelogは、ユーザーのBlueskyデータを定期的に取得し、データベースに永続化することで、高速なデータアクセスとBluesky APIのレートリミット遵守を実現します。

*   **データ取得のトリガー:** ユーザーログイン時、または定期的に実行されるバックグラウンドプロセスによって、Bluesky APIから最新のデータが取得されます。
*   **取得対象データ:** ユーザーのBlueskyプロフィール情報、投稿、いいねが主な取得対象です。投稿に付随するメディアやハッシュタグも抽出・保存されます。
*   **データモデル:** 取得されたデータは、ユーザー情報、投稿情報、いいね情報、メディア情報、ハッシュタグ情報、日別統計情報といった形でデータベースに保存されます。これにより、Bluesky上の活動履歴が構造化された形で保持されます。
*   **統計情報の集計:** 日ごとの投稿数、いいね数、リプライ数、リポスト数、メンション数などの統計情報が自動的に集計され、更新されます。

### 3.3. 提供機能とデータ表示

Bluelogは、永続化されたBlueskyデータに基づき、以下の機能を提供します。

*   **ユーザープロフィール表示:** ユーザーの基本情報、統計情報、投稿一覧を表示します。投稿は検索、日付/月別アーカイブ、ソートが可能です。
*   **いいね履歴表示:** ユーザーが行った「いいね」の一覧を表示し、元の投稿コンテンツへのリンクを提供します。
*   **メンションランキング:** ユーザーがメンションした相手のランキングを表示します。
*   **ハッシュタグランキング:** ユーザーが使用したハッシュタグのランキングを表示します。
*   **活動統計グラフ:** ユーザーのBluesky活動の日ごとの統計をグラフで視覚化します。
*   **ユーザー設定:** プロフィール公開設定の変更、投稿データのエクスポート、アカウント削除機能を提供します。

## 4. 運用方針

### 4.1. 招待コード制の導入（サービス稼働初期）

Bluelogのサービス稼働初期段階においては、システムの安定性と品質を確保するため、ユーザー登録を招待コード制とします。これは、段階的なユーザー増加を管理し、予期せぬ問題への対応を容易にするための戦略です。

*   **目的:**
    *   **動作チェック:** 少数の招待ユーザーを通じて、新規ユーザー登録からデータ同期、閲覧までのアプリケーションフローが本番環境で想定通りに動作するかを確認します。
    *   **負荷チェック:** 段階的にユーザー数を増やすことで、システムがどの程度の同時接続数やデータ量に耐えられるかを検証し、ボトルネックを特定します。
    *   **段階的なユーザー増加:** サービス開始直後の予期せぬ問題発生時の影響範囲を限定し、迅速な修正と対応を可能にします。
    *   **フィードバックの収集:** 初期ユーザーからのフィードバックを積極的に収集し、機能改善やUI/UXの向上に役立てます。
*   **導入フェーズ:** Bluelogの一般公開初期フェーズに限定して適用されます。このフェーズでは、招待コードを持たないユーザーは登録できません。
*   **運用方法:**
    *   **招待コードの発行:** 管理者のみが招待コードを発行できる機能を設けます。招待コードは、一意で推測が困難な文字列とします。
    *   **登録時の必須入力:** ユーザー登録フォームにおいて、招待コードの入力を必須項目とします。
    *   **一回限りの使用:** 発行された招待コードは、原則として一度のみ使用可能とし、再利用は不可とします。
    *   **招待コードの配布:** 招待コードは、信頼できるチャネルを通じて、限定されたユーザーに配布されます。
*   **解除条件:**
    *   システムの安定性（パフォーマンス、エラー発生率、リソース使用量など）が一定の基準を満たし、大規模なユーザーベースに対応可能と判断された段階で、招待コード制は解除される可能性があります。解除の判断は、運用チームによって行われます。
*   **セキュリティ上の考慮事項:**
    *   招待コードはデータベースにハッシュ化して保存するか、有効期限を設定するなど、セキュリティを考慮した管理を行います。
    *   招待コードの配布方法についても、情報漏洩のリスクを最小限に抑えるための対策を講じます。

## 5. 今後の開発方針

*   **テストの拡充:** 現在テストカバレッジが低い状態です。Bluesky連携部分のモック化を含めたテストを追加し、品質保証を強化します。
*   **フロントエンドの改善:** よりインタラクティブでリッチなユーザーインターフェースを提供するため、モダンなJavaScriptフレームワークの導入を検討します。
*   **エラーハンドリングの強化:** Bluesky APIリクエストの失敗やデータ処理中のエラーなど、あらゆるエラーシナリオに対する堅牢なハンドリングメカニズムを実装します。
*   **パフォーマンス最適化:** 大規模なデータ量やユーザー数に対応するため、データベースクエリの最適化、キャッシュ戦略の導入、非同期処理の活用などにより、アプリケーション全体のパフォーマンス向上を図ります。
*   **スケーラビリティの向上:** ユーザー数の増加に対応できるよう、水平スケーリングを考慮したアーキテクチャ設計や、クラウドサービスの活用を検討します。

## 6. コードルール

プロジェクトのコードルールについては、プロジェクトルートの `GEMINI.md` を参照してください。
